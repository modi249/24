name: VLESS-Ngrok-AutoTunnel
on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install Ngrok and Dependencies
      run: |
        sudo apt update -y
        sudo apt install -y unzip wget
        wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
        unzip ngrok-stable-linux-amd64.zip
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Create Xray Config using echo (Safe YAML)
      run: |
        echo '{' > config.json
        echo '  "log": {' >> config.json
        echo '    "loglevel": "info"' >> config.json
        echo '  },' >> config.json
        echo '  "inbounds": [{' >> config.json
        echo '    "port": 443,' >> config.json
        echo '    "protocol": "vless",' >> config.json
        echo '    "settings": {' >> config.json
        echo '      "clients": [{' >> config.json
        echo '        "id": "79e26e20-56b3-4f1e-8484-9844e13d11b2",' >> config.json
        echo '        "flow": "xtls-rprx-vision"' >> config.json
        echo '      }]' >> config.json
        echo '    },' >> config.json
        echo '    "streamSettings": {' >> config.json
        echo '      "network": "ws",' >> config.json
        echo '      "security": "none",' >> config.json
        echo '      "wsSettings": {' >> config.json
        echo '        "path": "/vless-archfx"' >> config.json
        echo '      }' >> config.json
        echo '    }' >> config.json
        echo '  }],' >> config.json
        echo '  "outbounds": [{' >> config.json
        echo '    "protocol": "freedom"' >> config.json
        echo '  }]' >> config.json
        echo '}' >> config.json

    - name: Run Xray and Ngrok Tunnel
      run: |
        wget https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
        unzip Xray-linux-64.zip
        chmod +x xray

        # ุดุบูู Xray ูู ุงูุฎูููุฉ
        nohup ./xray run -c config.json > xray.log 2>&1 &

        # ุดุบูู ngrok ูู ุงูุฎูููุฉ ูุน ุชุณุฌูู ุงูุณุฌูุงุช
        nohup ./ngrok tcp 443 --region us --log=stdout > ngrok.log 2>&1 &

        echo "โณ ูู ุงูุชุธุงุฑ ุชุดุบูู ุงูููู..."
        sleep 40

        echo "==== ุณุฌู ngrok ===="
        cat ngrok.log
        echo "===================="

    - name: Extract Ngrok TCP Address
      id: get_tunnel
      run: |
        NGROK_URL=$(grep -Eo 'tcp://[0-9a-zA-Z\.\-:]*' ngrok.log | tail -n 1)
        if [ -z "$NGROK_URL" ]; then
          echo "VLESS_ADDR=Tunnel-Failed-Check-Logs" >> $GITHUB_ENV
        else
          echo "VLESS_ADDR=${NGROK_URL#tcp://}" >> $GITHUB_ENV
        fi

    - name: Display VLESS Link
      run: |
        echo "==========================================="
        echo "โ ููู Ngrok ุชู ุฅูุดุงุคู ุจูุฌุงุญ"
        echo "๐ VLESS Configuration Link:"
        echo ""
        echo "vless://79e26e20-56b3-4f1e-8484-9844e13d11b2@${VLESS_ADDR}?encryption=none&security=tls&type=ws&host=archfx.io&path=/vless-archfx&sni=archfx.io&allowInsecure=1#ArchFX_CloudFront_VLESS_Tunnel"
        echo "==========================================="
