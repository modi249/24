name: VLESS-RS-Tunnel-Final

on:
  workflow_dispatch:

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Generate Random Password & Set Root
        id: passwd
        run: |
          PASS=$(openssl rand -base64 12)
          echo "root:$PASS" | sudo chpasswd
          echo "PASSWORD=$PASS" >> $GITHUB_ENV
          echo "ðŸ”‘ Generated random root password"

      - name: Install Dependencies, Nginx, and UFW
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server ufw curl wget jq unzip nginx
          sudo ufw allow 22/tcp
          sudo ufw allow 443/tcp
          sudo ufw --force enable
          sudo service ssh restart
          echo "âœ… Dependencies & security configured"

      - name: Install Xray Manually & Service
        run: |
          XRAY_VERSION=$(curl -s "https://api.github.com/repos/XTLS/Xray-core/releases/latest" | jq -r '.tag_name')
          XRAY_FILENAME="Xray-linux-64.zip"
          XRAY_DOWNLOAD_URL="https://github.com/XTLS/Xray-core/releases/download/$XRAY_VERSION/$XRAY_FILENAME"
          wget -q $XRAY_DOWNLOAD_URL
          sudo unzip -o $XRAY_FILENAME -d /usr/local/bin/
          sudo mkdir -p /usr/local/etc/xray/
          sudo mkdir -p /etc/xray/
          sudo tee /etc/systemd/system/xray.service > /dev/null <<EOL
[Unit]
Description=Xray Service
After=network.target nss-lookup.target

[Service]
User=root
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=true
ExecStart=/usr/local/bin/xray run -config /usr/local/etc/xray/config.json
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOL
          echo "âœ… Xray installed and service configured."

      - name: Configure Xray VLESS
        run: |
          sudo tee /usr/local/etc/xray/config.json > /dev/null <<EOL
{
  "log": { "loglevel": "warning" },
  "inbounds": [
    {
      "port": 443,
      "protocol": "vless",
      "settings": { "clients": [ { "id": "79e26e20-56b3-4f1e-8484-9844e13d11b2", "level": 0, "email": "user@example.com" } ], "decryption": "none" },
      "streamSettings": {
        "network": "ws",
        "security": "tls",
        "tlsSettings": { "alpn": [ "http/1.1" ], "allowInsecure": true, "fingerprint": "random" },
        "wsSettings": { "path": "/vless-archfx" }
      }
    }
  ],
  "outbounds": [ { "protocol": "freedom", "settings": {} } ]
}
EOL
          sudo systemctl daemon-reload
          sudo systemctl restart xray
          echo "âœ… Xray VLESS configured and running on port 443."

      - name: Install and Run RS-Tunnel
        run: |
          curl -sL "https://github.com/radovsky/r-tunnel/releases/download/v1.1.2/r-tunnel_linux_amd64" -o r-tunnel
          chmod +x r-tunnel
          nohup ./r-tunnel tunnel --host=r.tunnel.workers.dev --remote-port=443 --local-port=443 > /dev/null 2>&1 &
          echo "âœ… RS-Tunnel started on port 443"

      - name: Save Credentials
        run: |
          echo "VLESS Port: 443" > vps-info.txt
          echo "User: root, Pass: $PASSWORD" >> vps-info.txt
          echo "Note: RS-Tunnel is running on port 443" >> vps-info.txt

      - name: Upload VPS Info
        uses: actions/upload-artifact@v4
        with:
          name: vps-info
          path: vps-info.txt

      - name: Keep VPS Alive
        run: |
          while true; do
            echo "[$(date)] VPS running..."
            sleep 300
          done
