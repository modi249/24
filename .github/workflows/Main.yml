name: VLESS-Ngrok-Manual-Tunnel

on:
  workflow_dispatch:

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Generate Random Password
        id: passwd
        run: |
          PASS=$(openssl rand -base64 12)
          echo "root:$PASS" | sudo chpasswd
          echo "PASSWORD=$PASS" >> $GITHUB_ENV
          echo "ðŸ”‘ Generated random root password"

      - name: Install Dependencies & Configure SSH/UFW
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server ufw curl wget jq
          sudo ufw allow 22/tcp
          sudo ufw allow 443/tcp
          sudo ufw --force enable
          sudo service ssh restart
          echo "âœ… Dependencies & security configured"

      - name: Install Xray (VLESS Server)
        run: |
          # ØªØ«Ø¨ÙŠØª Xray Core
          bash -c "$(curl -L https://raw.githubusercontent.com/XTLS/Xray-install/main/install-release.sh)" @ install
          sudo mkdir -p /etc/xray/
          # Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù€ VLESS
          XRAY_CONFIG='{
            "log": {
              "loglevel": "warning"
            },
            "inbounds": [
              {
                "port": 443,
                "protocol": "vless",
                "settings": {
                  "clients": [
                    {
                      "id": "79e26e20-56b3-4f1e-8484-9844e13d11b2",
                      "level": 0,
                      "email": "user@example.com"
                    }
                  ],
                  "decryption": "none"
                },
                "streamSettings": {
                  "network": "ws",
                  "security": "tls",
                  "tlsSettings": {
                    "alpn": [ "http/1.1" ],
                    "allowInsecure": true, 
                    "fingerprint": "random" 
                  },
                  "wsSettings": {
                    "path": "/vless-archfx"
                  }
                }
              }
            ],
            "outbounds": [
              {
                "protocol": "freedom",
                "settings": {}
              }
            ]
          }'
          echo "$XRAY_CONFIG" | sudo tee /usr/local/etc/xray/config.json > /dev/null
          sudo systemctl restart xray
          echo "âœ… Xray VLESS configured and running on port 443."

      - name: Install and Configure Ngrok Manually
        run: |
          # 1. ØªØ«Ø¨ÙŠØª Ngrok
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          # 2. Ø¥Ø¶Ø§ÙØ© Auth Token
          ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          # 3. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ÙÙ‚ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ù…Ù†ÙØ° 443
          ./ngrok tcp 443 --region us &
          # 4. Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§ Ø­ØªÙ‰ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù†ÙÙ‚
          sleep 5

      - name: Get Ngrok Tunnel Address
        id: ngrok_info
        run: |
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ø§Ø¨Ø· Ø§Ù„Ù†ÙÙ‚
          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          # ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„ÙŠÙ†Ø§Ø³Ø¨ VLESS
          VLESS_ADDR=$(echo "${NGROK_URL#tcp://}") 
          echo "VLESS_ADDR=$VLESS_ADDR" >> $GITHUB_ENV
          echo "ðŸ”¥ Ngrok Address: $VLESS_ADDR"

      - name: Save Credentials and Tunnel Info
        run: |
          echo "VLESS Address: $VLESS_ADDR" > vps-info.txt
          echo "VLESS Port: 443" >> vps-info.txt
          echo "User: root, Pass: $PASSWORD" >> vps-info.txt
        
      - name: Upload VPS Info
        uses: actions/upload-artifact@v4
        with:
          name: vps-info
          path: vps-info.txt

      - name: Keep VPS Alive
        run: |
          while true; do
            echo "[$(date)] VPS running..."
            sleep 300
          done
